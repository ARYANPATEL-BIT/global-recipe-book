name: Recipe File Validation

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - '**'

jobs:
  recipe-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js (for future HTML/CSS/JS lint)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: üîç Recipe File Consistency Check
        run: |
          echo "üîç Starting recipe file validation..."

          # Get all new or modified PDFs and HTMLs in this PR
          new_pdfs=$(git diff --name-only origin/main...HEAD | grep '\.pdf$' || true)
          new_htmls=$(git diff --name-only origin/main...HEAD | grep '\.html$' || true)

          fatal_errors=0

          # -----------------------------
          # 1Ô∏è‚É£ Check new PDFs
          # -----------------------------
          if [ -z "$new_pdfs" ]; then
            echo "‚ÑπÔ∏è No new PDF files detected in this PR."
          fi

          for pdf in $new_pdfs; do
            if [ ! -f "$pdf" ]; then
              continue
            fi

            base="${pdf%.pdf}"
            name=$(basename "$pdf" .pdf)
            country=$(basename $(dirname "$pdf"))
            jpg="assets/${country}/${name}.jpg"

            echo "----------------------------------------"
            echo "üìÑ New PDF detected: $pdf"

            # ‚úÖ Check naming convention: lowercase + underscores
            if [[ "$name" =~ ^[a-z0-9_]+$ ]]; then
              echo "‚úÖ PDF follows naming convention: ${name}.pdf"
            else
              echo "‚ùå PDF does NOT follow naming convention (recipe_name.pdf)"
              fatal_errors=$((fatal_errors+1))
            fi

            # ‚úÖ Check matching JPG exists
            if [ -f "$jpg" ]; then
              echo "‚úÖ Matching JPG found: ${name}.jpg"
            else
              echo "‚ùå Missing JPG for $name.pdf ‚Äî please check spelling, case, or folder"
              fatal_errors=$((fatal_errors+1))
            fi

            echo "----------------------------------------"
          done

          # -----------------------------
          # 2Ô∏è‚É£ Check new HTMLs
          # -----------------------------
          if [ -z "$new_htmls" ]; then
            echo "‚ÑπÔ∏è No new HTML files detected in this PR."
          fi

          for html in $new_htmls; do
            if [ ! -f "$html" ]; then
              continue
            fi

            base="${html%.html}"
            name=$(basename "$html" .html)
            country=$(basename $(dirname "$html"))
            pdf="recipes/${country}/${name}.pdf"

            echo "----------------------------------------"
            echo "üìÑ New HTML detected: $html"

            # ‚úÖ HTML naming convention
            if [[ "$name" =~ ^[a-z0-9_]+$ ]]; then
              echo "‚úÖ HTML follows naming convention: ${name}.html"
            else
              echo "‚ùå HTML does NOT follow naming convention (recipe_name.html)"
              fatal_errors=$((fatal_errors+1))
            fi

            # ‚úÖ Check corresponding PDF exists
            if [ -f "$pdf" ]; then
              echo "‚úÖ Corresponding PDF exists: ${name}.pdf"
            else
              echo "‚ùå Corresponding PDF missing: ${name}.pdf"
              fatal_errors=$((fatal_errors+1))
            fi

            # ‚úÖ Check if linked in index.html
            if grep -q "site/${country}/${name}.html" index.html; then
              echo "‚úÖ HTML linked in index.html"
            else
              echo "‚ùå HTML not linked in index.html"
              fatal_errors=$((fatal_errors+1))
            fi

            echo "----------------------------------------"
          done

          # -----------------------------
          # Exit with failure if any fatal errors
          # -----------------------------
          if [ "$fatal_errors" -gt 0 ]; then
            echo "‚ùå Found $fatal_errors fatal issues. Failing the workflow."
            exit 1
          else
            echo "‚úÖ All recipe file checks passed successfully!"
          fi
